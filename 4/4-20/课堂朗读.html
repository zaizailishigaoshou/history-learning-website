<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æœ—è¯»æ¿€åŠ±ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { 
            background: linear-gradient(135deg, 
                #e0f2fe 0%, 
                #fef3c7 25%, 
                #dcfce7 50%, 
                #fce7f3 75%, 
                #ede9fe 100%
            ); 
            min-height: 100vh; 
            padding: 20px; 
            position: relative; 
            overflow-x: hidden;
        }

        .floating-reward {
            position: absolute;
            font-size: 2.5rem;
            pointer-events: none;
            z-index: 3;
            opacity: 0;
            animation: rewardFloat 2s forwards;
        }

        @keyframes rewardFloat {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-150px) scale(0.5); opacity: 0; }
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 25px; 
            padding: 30px; 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); 
            position: relative; 
            z-index: 2;
            border: 8px solid linear-gradient(90deg, #f59e0b, #ef4444, #8b5cf6, #10b981);
        }

        header { 
            text-align: center; 
            margin-bottom: 30px; 
            padding-bottom: 20px; 
            border-bottom: 4px dashed #f59e0b;
            background: linear-gradient(90deg, #f59e0b, #ef4444, #8b5cf6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        h1 { 
            font-size: 3.5rem; 
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            animation: titleGlow 3s infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
            to { text-shadow: 0 0 25px rgba(16, 185, 129, 0.7); }
        }

        .classroom-layout { 
            display: grid; 
            grid-template-columns: 1fr 2fr 1fr; 
            gap: 25px; 
            margin-bottom: 30px; 
        }

        @media (max-width: 1200px) { 
            .classroom-layout { grid-template-columns: 1fr; } 
        }

        .learning-station { 
            background: linear-gradient(145deg, #ffffff, #f8fafc); 
            border-radius: 20px; 
            padding: 25px; 
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 4px solid;
            position: relative;
            overflow: hidden;
        }

        .learning-station::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #f59e0b, #ef4444, #8b5cf6, #10b981);
        }

        .students-station { border-color: #3b82f6; }
        .reading-station { border-color: #10b981; }
        .achievement-station { border-color: #f59e0b; }

        .student-card { 
            display: flex; 
            align-items: center; 
            padding: 18px; 
            background: linear-gradient(135deg, #f8fafc, #f1f5f9); 
            border-radius: 15px; 
            margin-bottom: 15px; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .student-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: transform 0.6s;
        }

        .student-card:hover::after {
            transform: rotate(45deg) translate(50%, 50%);
        }

        .student-card:hover { 
            transform: translateY(-8px) scale(1.03); 
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.15);
        }

        .student-card.active { 
            background: linear-gradient(135deg, #dbeafe, #bfdbfe); 
            border-color: #3b82f6;
            animation: studentActive 2s infinite;
        }

        @keyframes studentActive {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }

        .student-avatar { 
            font-size: 3.2rem; 
            margin-right: 20px; 
            width: 85px; 
            height: 85px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: white; 
            border-radius: 50%; 
            border: 5px solid;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            transition: all 0.5s;
        }

        .student-card:hover .student-avatar {
            transform: rotate(360deg) scale(1.1);
        }

        .student-1 { border-color: #ef4444; }
        .student-2 { border-color: #3b82f6; }
        .student-3 { border-color: #10b981; }
        .student-4 { border-color: #8b5cf6; }

        /* æ™ºèƒ½æœ—è¯»æ°”æ³¡ */
        .smart-bubble-area {
            position: relative;
            height: 500px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 20px;
            overflow: hidden;
            border: 6px solid #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reading-bubble {
            position: relative;
            width: 220px;
            height: 220px;
            background: radial-gradient(circle at 30% 30%, #60a5fa, #3b82f6);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                inset 0 -25px 50px rgba(0, 0, 0, 0.25),
                inset 0 25px 50px rgba(255, 255, 255, 0.4),
                0 0 100px rgba(59, 130, 246, 0.6);
            cursor: pointer;
            z-index: 10;
        }

        .bubble-emoji {
            font-size: 5rem;
            margin-bottom: 15px;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
            transition: all 0.3s;
        }

        .bubble-motivation {
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: rgba(0, 0, 0, 0.25);
            padding: 8px 20px;
            border-radius: 25px;
            max-width: 180px;
            text-align: center;
            line-height: 1.4;
        }

        /* èƒ½é‡å…‰ç¯ */
        .energy-halo {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 5px solid rgba(255, 255, 255, 0.6);
            animation: energyPulse 2s infinite;
            z-index: 5;
        }

        @keyframes energyPulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.3); opacity: 0.4; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        /* åˆ†æ•°é‡Œç¨‹ç¢‘ */
        .milestone-indicator {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: bold;
            z-index: 20;
            display: none;
            backdrop-filter: blur(10px);
        }

        /* æ§åˆ¶é¢æ¿ */
        .reading-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
        }

        .reading-btn {
            padding: 25px;
            border: none;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: all 0.4s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .reading-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: rotate(45deg);
            transition: transform 0.6s;
        }

        .reading-btn:hover::after {
            transform: rotate(45deg) translate(50%, 50%);
        }

        .reading-btn:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 40px rgba(0, 0, 0, 0.2);
        }

        .start-reading { 
            background: linear-gradient(135deg, #10b981, #059669); 
        }

        .stop-reading { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
        }

        .reset-scores { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed); 
        }

        /* åˆ†æ•°æ˜¾ç¤º */
        .score-celebration {
            text-align: center;
            margin: 25px 0;
            padding: 25px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 20px;
            color: #78350f;
            position: relative;
            overflow: hidden;
        }

        .current-score {
            font-size: 4.5rem;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .score-label {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .next-milestone {
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 15px;
            display: inline-block;
        }

        /* é‡Œç¨‹ç¢‘è¿›åº¦ */
        .milestone-tracker {
            margin: 20px 0;
        }

        .milestone-bar {
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .milestone-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6, #ef4444);
            border-radius: 15px;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .milestone-markers {
            position: relative;
            height: 40px;
            margin-top: 10px;
        }

        .milestone-marker {
            position: absolute;
            width: 2px;
            height: 20px;
            background: #9ca3af;
            transform: translateX(-50%);
        }

        .milestone-label {
            position: absolute;
            top: 25px;
            transform: translateX(-50%);
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: bold;
        }

        /* æ¿€åŠ±åé¦ˆ */
        .encouragement-feed {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 20px;
            border-left: 8px solid #3b82f6;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .encouragement-message {
            font-size: 1.7rem;
            text-align: center;
            color: #1e40af;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }

        /* è¡¨æƒ…åŠ¨ç”» */
        .emoji-celebration {
            animation: emojiCelebrate 0.8s;
        }

        @keyframes emojiCelebrate {
            0% { transform: scale(1); }
            25% { transform: scale(1.5) rotate(-15deg); }
            50% { transform: scale(1.8) rotate(15deg); }
            75% { transform: scale(1.5) rotate(-10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .score-jump {
            animation: scoreJump 0.5s;
        }

        @keyframes scoreJump {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        /* é‡Œç¨‹ç¢‘åº†ç¥ */
        .milestone-celebration {
            position: fixed;
            font-size: 4rem;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            animation: milestoneFloat 3s forwards;
        }

        @keyframes milestoneFloat {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            10% { transform: translateY(-20px) scale(1.5); opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-300px) scale(0.3); opacity: 0; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .classroom-layout { grid-template-columns: 1fr; }
            .reading-controls { grid-template-columns: 1fr; }
            h1 { font-size: 2.5rem; }
        }

        /* ç‰¹æ®Šæ•ˆæœ */
        .confetti-burst {
            position: fixed;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 99;
        }

        /* åˆ†æ•°ç­‰çº§é¢œè‰² */
        .level-0 { color: #6b7280; }
        .level-100 { color: #3b82f6; }
        .level-200 { color: #10b981; }
        .level-300 { color: #f59e0b; }
        .level-400 { color: #ef4444; }
        .level-500 { color: #8b5cf6; }
        .level-600 { color: #ec4899; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-graduation-cap"></i> æ™ºèƒ½æœ—è¯»æ¿€åŠ±ç³»ç»Ÿ</h1>
            <p style="font-size: 1.5rem; color: #4b5563; margin-top: 15px; font-weight: bold;">
                ä¸‰ç™¾åˆ†ä»¥ä¸Šï¼Œæ¯æ»¡ä¸€ç™¾åˆ†éƒ½æœ‰ç‰¹åˆ«å¥–åŠ±ï¼ğŸ’¯
            </p>
        </header>

        <div class="classroom-layout">
            <!-- å·¦ä¾§ï¼šå­¦ç”Ÿåˆ—è¡¨ -->
            <div>
                <div class="learning-station students-station">
                    <h2 style="color: #3b82f6; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-user-graduate fa-beat"></i> æœ—è¯»å°èƒ½æ‰‹
                    </h2>
                    <div id="students-list">
                        <div class="student-card active" onclick="selectStudent(0)">
                            <div class="student-avatar student-1">ğŸ§‘â€ğŸ“</div>
                            <div>
                                <h3 class="level-0" id="studentName1">æœ—è¯»ä¹‹æ˜Ÿ</h3>
                                <p>å½“å‰åˆ†æ•°: <span id="score1" style="font-weight: bold; font-size: 1.2rem;">0</span></p>
                                <p style="color: #ef4444; font-size: 0.9rem;" id="studentStatus1">å‡†å¤‡å¼€å§‹æœ—è¯»...</p>
                            </div>
                        </div>
                        <div class="student-card" onclick="selectStudent(1)">
                            <div class="student-avatar student-2">ğŸ‘©â€ğŸ“</div>
                            <div>
                                <h3 class="level-0" id="studentName2">è¯­éŸ³è¾¾äºº</h3>
                                <p>å½“å‰åˆ†æ•°: <span id="score2" style="font-weight: bold; font-size: 1.2rem;">0</span></p>
                                <p style="color: #3b82f6; font-size: 0.9rem;" id="studentStatus2">ç­‰å¾…è½®æ¬¡...</p>
                            </div>
                        </div>
                        <div class="student-card" onclick="selectStudent(2)">
                            <div class="student-avatar student-3">ğŸ‘¨â€ğŸ“</div>
                            <div>
                                <h3 class="level-0" id="studentName3">å‘éŸ³é«˜æ‰‹</h3>
                                <p>å½“å‰åˆ†æ•°: <span id="score3" style="font-weight: bold; font-size: 1.2rem;">0</span></p>
                                <p style="color: #10b981; font-size: 0.9rem;" id="studentStatus3">æ‘©æ‹³æ“¦æŒ...</p>
                            </div>
                        </div>
                        <div class="student-card" onclick="selectStudent(3)">
                            <div class="student-avatar student-4">ğŸ‘©â€ğŸ“</div>
                            <div>
                                <h3 class="level-0" id="studentName4">æœ—è¯»å¤§å¸ˆ</h3>
                                <p>å½“å‰åˆ†æ•°: <span id="score4" style="font-weight: bold; font-size: 1.2rem;">0</span></p>
                                <p style="color: #8b5cf6; font-size: 0.9rem;" id="studentStatus4">è·ƒè·ƒæ¬²è¯•...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="learning-station" style="margin-top: 25px; border-color: #ec4899;">
                    <h2 style="color: #ec4899; margin-bottom: 20px;">
                        <i class="fas fa-medal"></i> é‡Œç¨‹ç¢‘è¯´æ˜
                    </h2>
                    <div style="padding: 15px; background: #fdf2f8; border-radius: 15px;">
                        <div style="margin-bottom: 15px;">
                            <h4 style="color: #be185d;">ğŸ¯ 300åˆ†é‡Œç¨‹ç¢‘è§„åˆ™</h4>
                            <p style="color: #6b7280; font-size: 0.95rem; line-height: 1.5;">
                                ä»300åˆ†å¼€å§‹ï¼Œæ¯æ»¡100åˆ†è‡ªåŠ¨è§¦å‘ç‰¹åˆ«åº†ç¥ï¼<br>
                                <strong>300åˆ†</strong>ï¼šçƒ­çƒˆæŒå£° ğŸ‘<br>
                                <strong>400åˆ†</strong>ï¼šæ¬¢å‘¼å–å½© ğŸ‰<br>
                                <strong>500åˆ†</strong>ï¼šèƒœåˆ©çƒŸèŠ± ğŸ†<br>
                                <strong>600åˆ†</strong>ï¼šå…¨å±åº†ç¥ ğŸ†
                            </p>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4 style="color: #7c3aed;">ğŸŒŸ è¡¨æƒ…æ¿€åŠ±ç³»ç»Ÿ</h4>
                            <p style="color: #6b7280; font-size: 0.95rem; line-height: 1.5;">
                                æ ¹æ®æœ—è¯»è¡¨ç°ï¼Œæ°”æ³¡è¡¨æƒ…ä¼šå˜åŒ–ï¼š<br>
                                â€¢ å£°éŸ³æ´ªäº® â†’ è¡¨æƒ…å¼€å¿ƒ ğŸ˜Š<br>
                                â€¢ å‘éŸ³æ ‡å‡† â†’ è¡¨æƒ…å…´å¥‹ ğŸ˜„<br>
                                â€¢ æŒç»­ä¼˜ç§€ â†’ è¡¨æƒ…æƒŠå–œ ğŸ¤©
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šæœ—è¯»åŒº -->
            <div>
                <div class="learning-station reading-station">
                    <h2 style="color: #10b981; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-volume-up fa-shake"></i> æ™ºèƒ½æœ—è¯»æ°”æ³¡
                    </h2>

                    <div class="smart-bubble-area">
                        <div class="reading-bubble" id="readingBubble">
                            <div class="bubble-emoji" id="bubbleEmoji">ğŸ¤</div>
                            <div class="bubble-motivation" id="bubbleMotivation">å‡†å¤‡å¼€å§‹æœ—è¯»</div>
                        </div>
                        <div class="energy-halo" id="energyHalo"></div>
                        <div class="milestone-indicator" id="milestoneIndicator">
                            <i class="fas fa-trophy"></i> é‡Œç¨‹ç¢‘è¾¾æˆ: <span id="milestoneText">0åˆ†</span>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <div class="milestone-tracker">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="font-weight: bold; color: #374151;">
                                    <i class="fas fa-chart-line"></i> é‡Œç¨‹ç¢‘è¿›åº¦
                                </span>
                                <span style="font-weight: bold;" id="currentMilestone">0/600åˆ†</span>
                            </div>
                            <div class="milestone-bar">
                                <div class="milestone-fill" id="milestoneFill" style="width: 0%"></div>
                            </div>
                            <div class="milestone-markers" id="milestoneMarkers">
                                <!-- é‡Œç¨‹ç¢‘æ ‡è®°ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="learning-station" style="margin-top: 25px; border-color: #f59e0b;">
                    <h2 style="color: #f59e0b; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-play-circle fa-bounce"></i> æœ—è¯»æ§åˆ¶
                    </h2>

                    <div class="reading-controls">
                        <button class="reading-btn start-reading" id="startReading" onclick="startReading()">
                            <i class="fas fa-microphone-alt fa-3x"></i>
                            <span>å¼€å§‹æœ—è¯»</span>
                        </button>
                        <button class="reading-btn stop-reading" id="stopReading" onclick="stopReading()" disabled>
                            <i class="fas fa-stop-circle fa-3x"></i>
                            <span>åœæ­¢æœ—è¯»</span>
                        </button>
                        <button class="reading-btn reset-scores" onclick="resetAllScores()">
                            <i class="fas fa-redo-alt fa-3x"></i>
                            <span>åˆ†æ•°å½’é›¶</span>
                        </button>
                    </div>

                    <div class="score-celebration">
                        <div class="current-score" id="currentScore">0</div>
                        <div class="score-label">å½“å‰æœ—è¯»å¾—åˆ†</div>
                        <div class="next-milestone" id="nextMilestone">
                            ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘: <span style="font-weight: bold;">300åˆ†</span>
                        </div>
                    </div>

                    <div class="encouragement-feed" id="encouragementFeed">
                        <div class="encouragement-message" id="encouragementMessage">
                            <i class="fas fa-comment-alt"></i> åŠ æ²¹ï¼è¯»å¾—è¶Šæ´ªäº®ï¼Œåˆ†æ•°æ¶¨å¾—è¶Šå¿«ï¼
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæˆå°±åŒº -->
            <div>
                <div class="learning-station achievement-station">
                    <h2 style="color: #f59e0b; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-trophy fa-spin"></i> æˆå°±æ®¿å ‚
                    </h2>

                    <div style="text-align: center; margin: 25px 0;">
                        <div style="padding: 25px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 20px; color: white;">
                            <div style="font-size: 2.8rem; font-weight: bold;" id="totalScore">0</div>
                            <div style="font-size: 1.2rem;">ç­çº§æ€»å¾—åˆ†</div>
                            <div style="margin-top: 15px; font-size: 0.9rem; opacity: 0.9;">
                                <i class="fas fa-users"></i> å››åå­¦ç”Ÿæ€»åˆ†
                            </div>
                        </div>
                    </div>

                    <div style="margin: 25px 0;">
                        <h3 style="color: #7c3aed; margin-bottom: 15px;">
                            <i class="fas fa-crown"></i> é‡Œç¨‹ç¢‘æˆå°±
                        </h3>
                        <div style="background: #f5f3ff; padding: 20px; border-radius: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <div>
                                    <span style="font-weight: bold; color: #f59e0b;">300åˆ†æˆå°±</span>
                                    <div style="font-size: 0.9rem; color: #6b7280;">çƒ­çƒˆæŒå£°é¼“åŠ±</div>
                                </div>
                                <div id="milestone300" style="opacity: 0.3;">
                                    <i class="fas fa-hands-clapping fa-2x"></i>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <div>
                                    <span style="font-weight: bold; color: #ef4444;">400åˆ†æˆå°±</span>
                                    <div style="font-size: 0.9rem; color: #6b7280;">å…¨åœºæ¬¢å‘¼å–å½©</div>
                                </div>
                                <div id="milestone400" style="opacity: 0.3;">
                                    <i class="fas fa-people-cheer fa-2x"></i>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <div>
                                    <span style="font-weight: bold; color: #8b5cf6;">500åˆ†æˆå°±</span>
                                    <div style="font-size: 0.9rem; color: #6b7280;">çƒŸèŠ±åº†å…¸ç»½æ”¾</div>
                                </div>
                                <div id="milestone500" style="opacity: 0.3;">
                                    <i class="fas fa-fireworks fa-2x"></i>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <span style="font-weight: bold; color: #ec4899;">600åˆ†æˆå°±</span>
                                    <div style="font-size: 0.9rem; color: #6b7280;">å…¨å±åº†ç¥ç››å…¸</div>
                                </div>
                                <div id="milestone600" style="opacity: 0.3;">
                                    <i class="fas fa-award fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 25px;">
                        <h3 style="color: #059669; margin-bottom: 15px;">
                            <i class="fas fa-history"></i> åº†ç¥è®°å½•
                        </h3>
                        <div id="celebrationHistory" style="
                            max-height: 200px;
                            overflow-y: auto;
                            padding: 15px;
                            background: #f0fdf4;
                            border-radius: 10px;
                            font-size: 0.9rem;
                        ">
                            <div style="text-align: center; color: #9ca3af; padding: 20px;">
                                <i class="fas fa-gift"></i> é‡Œç¨‹ç¢‘åº†ç¥è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// å…¨å±€çŠ¶æ€
let readingState = {
    currentStudent: 0,
    isReading: false,
    audioContext: null,
    analyser: null,
    microphone: null,
    animationId: null,
    currentVolume: 0,
    readingStartTime: 0,
    readingDuration: 0,
    studentScores: [0, 0, 0, 0],
    milestoneAchievements: {
        300: false,
        400: false,
        500: false,
        600: false
    },
    lastMilestone: 0,
    encouragementHistory: []
};

// å­¦ç”Ÿä¿¡æ¯
const students = [
    { name: "æœ—è¯»ä¹‹æ˜Ÿ", color: "#ef4444", avatar: "ğŸ§‘â€ğŸ“" },
    { name: "è¯­éŸ³è¾¾äºº", color: "#3b82f6", avatar: "ğŸ‘©â€ğŸ“" },
    { name: "å‘éŸ³é«˜æ‰‹", color: "#10b981", avatar: "ğŸ‘¨â€ğŸ“" },
    { name: "æœ—è¯»å¤§å¸ˆ", color: "#8b5cf6", avatar: "ğŸ‘©â€ğŸ“" }
];

// é‡Œç¨‹ç¢‘é…ç½®
const milestones = [
    { score: 300, icon: "ğŸ‘", title: "300åˆ†æˆå°±", sound: "applause", message: "çƒ­çƒˆæŒå£°ï¼è¾¾åˆ°300åˆ†é‡Œç¨‹ç¢‘ï¼" },
    { score: 400, icon: "ğŸ‰", title: "400åˆ†æˆå°±", sound: "cheer", message: "æ¬¢å‘¼å–å½©ï¼è¾¾åˆ°400åˆ†é‡Œç¨‹ç¢‘ï¼" },
    { score: 500, icon: "ğŸ†", title: "500åˆ†æˆå°±", sound: "fireworks", message: "çƒŸèŠ±åº†å…¸ï¼è¾¾åˆ°500åˆ†é‡Œç¨‹ç¢‘ï¼" },
    { score: 600, icon: "ğŸ†", title: "600åˆ†æˆå°±", sound: "victory", message: "å…¨å±åº†ç¥ï¼è¾¾åˆ°600åˆ†é‡Œç¨‹ç¢‘ï¼" }
];

// è¡¨æƒ…æ¿€åŠ±é…ç½®ï¼ˆ300åˆ†ä»¥ä¸Šæ¯100åˆ†ä¸€ä¸ªç­‰çº§ï¼‰
const milestoneExpressions = [
    { score: 300, emojis: ["ğŸ˜Š", "ğŸ˜„", "ğŸ˜", "ğŸ¥³"], motivations: ["åŠ æ²¹ï¼ç»§ç»­å‰è¿›ï¼", "å¤ªæ£’äº†ï¼ä¿æŒè¿™ä¸ªèŠ‚å¥ï¼"] },
    { score: 400, emojis: ["ğŸ¤©", "ğŸ¥°", "ğŸ˜", "ğŸ˜"], motivations: ["å¤ªä¼˜ç§€äº†ï¼", "ä½ æ˜¯æœ€æ£’çš„ï¼"] },
    { score: 500, emojis: ["ğŸ”¥", "âœ¨", "ğŸŒŸ", "ğŸ’«"], motivations: ["ä¸å¯æ€è®®çš„è¿›æ­¥ï¼", "è®©äººæƒŠå¹çš„è¡¨ç°ï¼"] },
    { score: 600, emojis: ["ğŸ‘‘", "ğŸ…", "ğŸ–ï¸", "ğŸ¥‡"], motivations: ["æœ—è¯»å¤§å¸ˆï¼", "å† å†›çº§è¡¨ç°ï¼"] }
];

// éŸ³æ•ˆç³»ç»Ÿ
const soundSystem = {
    applause: () => {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        for (let i = 0; i < 120; i++) {
            setTimeout(() => {
                const osc = ac.createOscillator();
                const gain = ac.createGain();
                osc.connect(gain);
                gain.connect(ac.destination);

                osc.frequency.value = 200 + Math.random() * 600;
                osc.type = ['sine', 'square'][Math.floor(Math.random() * 2)];

                gain.gain.setValueAtTime(0, ac.currentTime);
                gain.gain.linearRampToValueAtTime(0.08, ac.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.4 + Math.random() * 0.4);

                osc.start(ac.currentTime);
                osc.stop(ac.currentTime + 0.8 + Math.random() * 0.4);
            }, i * 8);
        }
    },

    cheer: () => {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        for (let i = 0; i < 30; i++) {
            setTimeout(() => {
                const osc = ac.createOscillator();
                const gain = ac.createGain();
                osc.connect(gain);
                gain.connect(ac.destination);

                osc.frequency.value = 300 + Math.random() * 500;
                osc.type = 'sine';

                gain.gain.setValueAtTime(0, ac.currentTime);
                gain.gain.linearRampToValueAtTime(0.15, ac.currentTime + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.6);

                osc.start(ac.currentTime);
                osc.stop(ac.currentTime + 0.6);
            }, i * 50);
        }
    },

    fireworks: () => {
        createFireworksEffect();
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        for (let i = 0; i < 12; i++) {
            setTimeout(() => {
                const osc = ac.createOscillator();
                const gain = ac.createGain();
                osc.connect(gain);
                gain.connect(ac.destination);

                osc.frequency.value = 700;
                osc.type = 'sawtooth';

                gain.gain.setValueAtTime(0, ac.currentTime);
                gain.gain.linearRampToValueAtTime(0.3, ac.currentTime + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 1.2);

                osc.frequency.exponentialRampToValueAtTime(100, ac.currentTime + 1.2);

                osc.start(ac.currentTime);
                osc.stop(ac.currentTime + 1.2);
            }, i * 100);
        }
    },

    victory: () => {
        createVictoryEffect();
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        const victoryNotes = [
            { freq: 523.25, time: 0 },
            { freq: 587.33, time: 200 },
            { freq: 659.25, time: 400 },
            { freq: 698.46, time: 600 },
            { freq: 783.99, time: 800 },
            { freq: 880.00, time: 1000 },
            { freq: 987.77, time: 1200 },
            { freq: 1046.50, time: 1400 }
        ];

        victoryNotes.forEach(note => {
            setTimeout(() => {
                const osc = ac.createOscillator();
                const gain = ac.createGain();
                osc.connect(gain);
                gain.connect(ac.destination);

                osc.frequency.value = note.freq;
                osc.type = 'triangle';

                gain.gain.setValueAtTime(0, ac.currentTime);
                gain.gain.linearRampToValueAtTime(0.25, ac.currentTime + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.5);

                osc.start(ac.currentTime);
                osc.stop(ac.currentTime + 0.5);
            }, note.time);
        });
    },

    scoreTick: () => {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.connect(gain);
        gain.connect(ac.destination);

        osc.frequency.value = 800;
        osc.type = 'sine';

        gain.gain.setValueAtTime(0, ac.currentTime);
        gain.gain.linearRampToValueAtTime(0.1, ac.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.1);

        osc.start(ac.currentTime);
        osc.stop(ac.currentTime + 0.1);
    },

    bubblePop: () => {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.connect(gain);
        gain.connect(ac.destination);

        osc.frequency.value = 600;
        osc.type = 'sine';

        gain.gain.setValueAtTime(0, ac.currentTime);
        gain.gain.linearRampToValueAtTime(0.2, ac.currentTime + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.2);

        osc.frequency.exponentialRampToValueAtTime(200, ac.currentTime + 0.2);

        osc.start(ac.currentTime);
        osc.stop(ac.currentTime + 0.2);
    }
};

// é€‰æ‹©å­¦ç”Ÿ
function selectStudent(index) {
    if (readingState.isReading) return;

    readingState.currentStudent = index;

    // æ›´æ–°å­¦ç”Ÿå¡ç‰‡
    document.querySelectorAll('.student-card').forEach((card, i) => {
        card.classList.toggle('active', i === index);
    });

    // æ›´æ–°å­¦ç”ŸçŠ¶æ€
    updateStudentStatus();

    // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
    updateScoreDisplay();

    // æ›´æ–°æ°”æ³¡é¢œè‰²
    updateBubbleColor();

    showEncouragement(`${students[index].name}ï¼Œå‡†å¤‡å¼€å§‹æœ—è¯»ï¼`);
}

// å¼€å§‹æœ—è¯»
async function startReading() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        readingState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        readingState.analyser = readingState.audioContext.createAnalyser();
        readingState.microphone = readingState.audioContext.createMediaStreamSource(stream);

        readingState.microphone.connect(readingState.analyser);
        readingState.analyser.fftSize = 512;
        readingState.isReading = true;
        readingState.readingStartTime = Date.now();

        // æ›´æ–°UIçŠ¶æ€
        document.getElementById('startReading').disabled = true;
        document.getElementById('stopReading').disabled = false;
        document.getElementById('energyHalo').style.display = 'block';
        document.getElementById('milestoneIndicator').style.display = 'none';

        // å¼€å§‹åŠ¨ç”»å¾ªç¯
        readingLoop();

        showEncouragement(`${students[readingState.currentStudent].name}å¼€å§‹æœ—è¯»ï¼åŠ æ²¹ï¼`);

        // æ·»åŠ æœ—è¯»è®°å½•
        addCelebrationRecord(`${students[readingState.currentStudent].name}å¼€å§‹æœ—è¯»`);

    } catch (error) {
        showEncouragement("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®ã€‚");
    }
}

// æœ—è¯»ä¸»å¾ªç¯
function readingLoop() {
    if (!readingState.isReading) return;

    const bufferLength = readingState.analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    readingState.analyser.getByteFrequencyData(dataArray);

    // è®¡ç®—éŸ³é‡
    let sum = 0;
    for (let i = 0; i < bufferLength; i++) {
        sum += dataArray[i];
    }
    let volume = Math.min(100, (sum / bufferLength / 128) * 100);

    // æ›´æ–°çŠ¶æ€
    readingState.currentVolume = volume;
    readingState.readingDuration = Date.now() - readingState.readingStartTime;

    // æ ¹æ®éŸ³é‡å¢åŠ åˆ†æ•°
    updateScoreByVolume(volume);

    // æ›´æ–°UI
    updateBubbleAppearance(volume);
    updateMilestoneProgress();
    checkMilestoneAchievements();
    provideAutoEncouragement(volume);

    // ç»§ç»­å¾ªç¯
    readingState.animationId = requestAnimationFrame(readingLoop);
}

// æ ¹æ®éŸ³é‡å¢åŠ åˆ†æ•°
function updateScoreByVolume(volume) {
    if (volume > 20) {
        // åŸºç¡€åˆ†æ•°å¢é•¿
        let baseIncrement = Math.floor(volume / 15);

        // éŸ³é‡è¶Šå¤§ï¼Œå¢é•¿è¶Šå¿«
        if (volume > 60) baseIncrement *= 2;
        if (volume > 80) baseIncrement *= 3;

        // 300åˆ†ä»¥ä¸Šé¢å¤–åŠ æˆ
        const currentScore = readingState.studentScores[readingState.currentStudent];
        if (currentScore >= 300) {
            baseIncrement *= 2; // 300åˆ†ä»¥ä¸Šåˆ†æ•°ç¿»å€
        }

        readingState.studentScores[readingState.currentStudent] += baseIncrement;

        // æ’­æ”¾åˆ†æ•°å¢é•¿éŸ³æ•ˆ
        if (baseIncrement >= 5 && Math.random() < 0.3) {
            soundSystem.scoreTick();
        }

        // æ›´æ–°æ˜¾ç¤º
        updateScoreDisplay();

        // æ›´æ–°æ€»åˆ†
        updateTotalScore();
    }
}

// æ›´æ–°æ°”æ³¡å¤–è§‚
function updateBubbleAppearance(volume) {
    const bubble = document.getElementById('readingBubble');
    const emoji = document.getElementById('bubbleEmoji');
    const motivation = document.getElementById('bubbleMotivation');

    // æ°”æ³¡å¤§å°ï¼ˆ1-2.5å€ï¼‰
    const scale = 1 + (volume / 60);
    bubble.style.transform = `scale(${scale})`;

    // æ°”æ³¡é¢œè‰²
    const currentScore = readingState.studentScores[readingState.currentStudent];
    let baseColor = students[readingState.currentStudent].color;

    if (currentScore >= 600) {
        baseColor = "#ec4899";
    } else if (currentScore >= 500) {
        baseColor = "#8b5cf6";
    } else if (currentScore >= 400) {
        baseColor = "#ef4444";
    } else if (currentScore >= 300) {
        baseColor = "#f59e0b";
    }

    // æ ¹æ®åˆ†æ•°è°ƒæ•´é¢œè‰²äº®åº¦
    const scoreBrightness = Math.min(50, Math.floor(currentScore / 20));
    const adjustedColor = adjustColorBrightness(baseColor, scoreBrightness);

    bubble.style.background = `radial-gradient(circle at 30% 30%, 
        ${adjustedColor}, 
        ${adjustColorBrightness(adjustedColor, -20)})`;

    // æ°”æ³¡é˜´å½±
    bubble.style.boxShadow = `
        inset 0 -25px 50px rgba(0, 0, 0, 0.3),
        inset 0 25px 50px rgba(255, 255, 255, 0.4),
        0 0 ${40 + volume * 0.6}px ${adjustedColor.replace(')', ', 0.6)').replace('rgb', 'rgba')}
    `;

    // æ›´æ–°è¡¨æƒ…å’Œé¼“åŠ±è¯­
    updateBubbleExpression(currentScore, volume, emoji, motivation);

    // å…‰ç¯åŠ¨ç”»é€Ÿåº¦
    const halo = document.getElementById('energyHalo');
    halo.style.animationDuration = `${1.5 - (volume / 100)}s`;
}

// æ›´æ–°æ°”æ³¡è¡¨æƒ…å’Œé¼“åŠ±è¯­
function updateBubbleExpression(score, volume, emojiElement, motivationElement) {
    let targetEmoji = "ğŸ¤";
    let targetMotivation = "å‡†å¤‡å¼€å§‹æœ—è¯»";

    if (score >= 600) {
        // 600åˆ†ä»¥ä¸Šï¼šå…¨å±åº†ç¥çº§è¡¨æƒ…
        const expressions = milestoneExpressions[3].emojis;
        const motivations = milestoneExpressions[3].motivations;
        targetEmoji = expressions[Math.floor((score - 600) / 25) % expressions.length];
        targetMotivation = motivations[Math.floor((score - 600) / 50) % motivations.length];
    } else if (score >= 500) {
        // 500-599åˆ†ï¼šçƒŸèŠ±åº†å…¸çº§è¡¨æƒ…
        const expressions = milestoneExpressions[2].emojis;
        const motivations = milestoneExpressions[2].motivations;
        targetEmoji = expressions[Math.floor((score - 500) / 25) % expressions.length];
        targetMotivation = motivations[Math.floor((score - 500) / 33) % motivations.length];
    } else if (score >= 400) {
        // 400-499åˆ†ï¼šæ¬¢å‘¼å–å½©çº§è¡¨æƒ…
        const expressions = milestoneExpressions[1].emojis;
        const motivations = milestoneExpressions[1].motivations;
        targetEmoji = expressions[Math.floor((score - 400) / 25) % expressions.length];
        targetMotivation = motivations[Math.floor((score - 400) / 33) % motivations.length];
    } else if (score >= 300) {
        // 300-399åˆ†ï¼šæŒå£°é¼“åŠ±çº§è¡¨æƒ…
        const expressions = milestoneExpressions[0].emojis;
        const motivations = milestoneExpressions[0].motivations;
        targetEmoji = expressions[Math.floor((score - 300) / 25) % expressions.length];
        targetMotivation = motivations[Math.floor((score - 300) / 33) % motivations.length];
    } else if (score >= 200) {
        // 200-299åˆ†ï¼šç§¯æè¿›æ­¥
        const emojis = ["ğŸ˜Š", "ğŸ™‚", "ğŸ¤—", "ğŸ‘"];
        const motivations = ["è¿›æ­¥å¾ˆå¤§ï¼", "ç»§ç»­åŠªåŠ›ï¼", "è¶Šæ¥è¶Šå¥½äº†ï¼", "åŠ æ²¹åŠ æ²¹ï¼"];
        targetEmoji = emojis[Math.floor(score / 50) % emojis.length];
        targetMotivation = motivations[Math.floor(score / 66) % motivations.length];
    } else if (score >= 100) {
        // 100-199åˆ†ï¼šåŸºç¡€é¼“åŠ±
        const emojis = ["ğŸ™‚", "ğŸ‘", "ğŸ’ª", "âœ¨"];
        const motivations = ["ä¸é”™ï¼", "ç»§ç»­åŠ æ²¹ï¼", "å£°éŸ³å¾ˆæ¸…æ™°ï¼", "è¯»å¾—çœŸå¥½ï¼"];
        targetEmoji = emojis[Math.floor(score / 50) % emojis.length];
        targetMotivation = motivations[Math.floor(score / 66) % motivations.length];
    } else if (score > 0) {
        // 1-99åˆ†ï¼šå…¥é—¨é¼“åŠ±
        const emojis = ["ğŸ‘‚", "ğŸ—£ï¸", "ğŸ’¬", "ğŸ“¢"];
        const motivations = ["å¼€å§‹å§ï¼", "å¤§å£°ä¸€ç‚¹ï¼", "ä½ å¯ä»¥çš„ï¼", "å‹‡æ•¢è¯»å‡ºæ¥ï¼"];
        targetEmoji = emojis[Math.floor(score / 25) % emojis.length];
        targetMotivation = motivations[Math.floor(score / 33) % motivations.length];
    }

    // æ ¹æ®éŸ³é‡å¾®è°ƒè¡¨æƒ…
    if (volume > 80) {
        targetEmoji = addVolumeEffect(targetEmoji);
    }

    // æ›´æ–°æ˜¾ç¤º
    if (emojiElement.textContent !== targetEmoji) {
        emojiElement.textContent = targetEmoji;
        emojiElement.classList.add('emoji-celebration');
        setTimeout(() => {
            emojiElement.classList.remove('emoji-celebration');
        }, 800);
    }

    motivationElement.textContent = targetMotivation;
}

// ä¸ºè¡¨æƒ…æ·»åŠ éŸ³é‡æ•ˆæœ
function addVolumeEffect(emoji) {
    const volumeEffects = {
        "ğŸ˜Š": "ğŸ˜„", "ğŸ˜„": "ğŸ˜", "ğŸ˜": "ğŸ¤©",
        "ğŸ™‚": "ğŸ˜Š", "ğŸ‘": "ğŸ‘", "ğŸ‘": "ğŸ™Œ",
        "ğŸ’ª": "ğŸ”¥", "âœ¨": "ğŸŒŸ", "ğŸŒŸ": "ğŸ’«",
        "ğŸ—£ï¸": "ğŸ“¢", "ğŸ“¢": "ğŸ”Š", "ğŸ”Š": "ğŸº"
    };
    return volumeEffects[emoji] || emoji;
}

// è°ƒæ•´é¢œè‰²äº®åº¦
function adjustColorBrightness(color, amount) {
    const hex = color.replace('#', '');
    const num = parseInt(hex, 16);

    let r = (num >> 16) + amount;
    let g = ((num >> 8) & 0x00FF) + amount;
    let b = (num & 0x0000FF) + amount;

    r = Math.min(Math.max(r, 0), 255);
    g = Math.min(Math.max(g, 0), 255);
    b = Math.min(Math.max(b, 0), 255);

    return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
}

// æ›´æ–°é‡Œç¨‹ç¢‘è¿›åº¦
function updateMilestoneProgress() {
    const currentScore = readingState.studentScores[readingState.currentStudent];
    const progress = Math.min(100, (currentScore / 600) * 100);

    document.getElementById('milestoneFill').style.width = progress + '%';
    document.getElementById('currentMilestone').textContent = currentScore + '/600åˆ†';

    // æ›´æ–°ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘æç¤º
    for (let i = milestones.length - 1; i >= 0; i--) {
        if (currentScore < milestones[i].score) {
            const nextScore = milestones[i].score;
            document.getElementById('nextMilestone').innerHTML = 
                `ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘: <span style="font-weight: bold;">${nextScore}åˆ†</span>`;
            break;
        }
    }
}

// æ£€æŸ¥é‡Œç¨‹ç¢‘æˆå°±
function checkMilestoneAchievements() {
    const currentScore = readingState.studentScores[readingState.currentStudent];

    // æ£€æŸ¥æ¯ä¸ªé‡Œç¨‹ç¢‘
    for (const milestone of milestones) {
        if (currentScore >= milestone.score && !readingState.milestoneAchievements[milestone.score]) {
            // è¾¾æˆé‡Œç¨‹ç¢‘
            celebrateMilestone(milestone);
            readingState.milestoneAchievements[milestone.score] = true;
            readingState.lastMilestone = milestone.score;

            // æ›´æ–°æˆå°±æ˜¾ç¤º
            updateAchievementDisplay(milestone.score);

            // æ·»åŠ åº†ç¥è®°å½•
            addCelebrationRecord(`${students[readingState.currentStudent].name}è¾¾æˆ${milestone.score}åˆ†é‡Œç¨‹ç¢‘ï¼`);

            // 300åˆ†ä»¥ä¸Šï¼Œæ¯æ»¡100åˆ†éƒ½æœ‰åº†ç¥
            if (milestone.score >= 300) {
                createHundredPointCelebration(milestone.score);
            }
        }
    }
}

// åº†ç¥é‡Œç¨‹ç¢‘
function celebrateMilestone(milestone) {
    // æ’­æ”¾å¯¹åº”éŸ³æ•ˆ
    soundSystem[milestone.sound]();

    // æ˜¾ç¤ºé‡Œç¨‹ç¢‘æŒ‡ç¤ºå™¨
    const indicator = document.getElementById('milestoneIndicator');
    const text = document.getElementById('milestoneText');

    text.textContent = milestone.score + 'åˆ†';
    indicator.style.display = 'block';
    indicator.style.background = `linear-gradient(135deg, ${students[readingState.currentStudent].color}, ${adjustColorBrightness(students[readingState.currentStudent].color, 50)})`;

    // 3ç§’åéšè—
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 3000);

    // æ˜¾ç¤ºåº†ç¥æ¶ˆæ¯
    showEncouragement(milestone.message);

    // åˆ›å»ºåº†ç¥ç‰¹æ•ˆ
    createMilestoneCelebration(milestone.score);
}

// åˆ›å»ºç™¾åˆ†åº†ç¥ï¼ˆ300åˆ†ä»¥ä¸Šæ¯æ»¡100åˆ†ï¼‰
function createHundredPointCelebration(score) {
    const currentScore = readingState.studentScores[readingState.currentStudent];

    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°100çš„æ•´æ•°å€ï¼ˆ300ä»¥ä¸Šï¼‰
    if (currentScore >= 300 && currentScore % 100 === 0 && currentScore !== readingState.lastMilestone) {
        const celebrationMessages = [
            `ğŸ¯ å¤ªæ£’äº†ï¼è¾¾åˆ°${currentScore}åˆ†ï¼`,
            `ğŸŒŸ ç¬¬${currentScore/100}ä¸ª100åˆ†è¾¾æˆï¼`,
            `ğŸ’¯ å®Œç¾ï¼${currentScore}åˆ†é‡Œç¨‹ç¢‘ï¼`,
            `ğŸ† çªç ´${currentScore}åˆ†å¤§å…³ï¼`
        ];

        const randomMessage = celebrationMessages[Math.floor(Math.random() * celebrationMessages.length)];
        showEncouragement(randomMessage);

        // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
        soundSystem.bubblePop();

        // åˆ›å»ºé£˜åŠ¨å¥–åŠ±
        createFloatingReward(currentScore);

        readingState.lastMilestone = currentScore;
    }
}

// æä¾›è‡ªåŠ¨é¼“åŠ±
function provideAutoEncouragement(volume) {
    const now = Date.now();
    const timeSinceLast = now - (readingState.lastEncouragementTime || 0);

    if (timeSinceLast > 5000) { // æ¯5ç§’æœ€å¤šä¸€æ¬¡
        const currentScore = readingState.studentScores[readingState.currentStudent];

        if (volume > 85) {
            const highVolumeMessages = [
                "éŸ³é‡å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼ğŸ”Š",
                "å£°éŸ³æ´ªäº®æœ‰åŠ›ï¼å¤ªä¼˜ç§€äº†ï¼ğŸ¤",
                "è¿™ä¸ªéŸ³é‡å¤ªç»™åŠ›äº†ï¼ç»§ç»­å†²ï¼ğŸ’¥"
            ];
            showEncouragement(highVolumeMessages[Math.floor(Math.random() * highVolumeMessages.length)]);
            readingState.lastEncouragementTime = now;
        } else if (currentScore >= 300 && volume > 70 && Math.random() < 0.3) {
            const milestoneMessages = [
                "300åˆ†ä»¥ä¸Šäº†ï¼æ¯100åˆ†éƒ½æœ‰åº†ç¥ï¼ğŸ¯",
                "ç»§ç»­åŠ æ²¹ï¼ä¸‹ä¸€ä¸ª100åˆ†åœ¨ç­‰ä½ ï¼ğŸ’ª",
                "å¤ªå‰å®³äº†ï¼åˆ†æ•°è¿˜åœ¨ä¸æ–­ä¸Šæ¶¨ï¼ğŸš€"
            ];
            showEncouragement(milestoneMessages[Math.floor(Math.random() * milestoneMessages.length)]);
            readingState.lastEncouragementTime = now;
        }
    }
}

// æ›´æ–°æˆå°±æ˜¾ç¤º
function updateAchievementDisplay(score) {
    const achievementElement = document.getElementById(`milestone${score}`);
    if (achievementElement) {
        achievementElement.style.opacity = '1';
        achievementElement.style.transform = 'scale(1.2)';
        achievementElement.style.transition = 'all 0.3s';

        setTimeout(() => {
            achievementElement.style.transform = 'scale(1)';
        }, 300);
    }
}

// æ›´æ–°åˆ†æ•°æ˜¾ç¤º
function updateScoreDisplay() {
    const currentScore = readingState.studentScores[readingState.currentStudent];

    // æ›´æ–°å½“å‰å­¦ç”Ÿåˆ†æ•°
    document.getElementById('currentScore').textContent = currentScore;
    document.getElementById('currentScore').classList.add('score-jump');
    setTimeout(() => {
        document.getElementById('currentScore').classList.remove('score-jump');
    }, 500);

    // æ›´æ–°å­¦ç”Ÿåˆ—è¡¨ä¸­çš„åˆ†æ•°
    document.getElementById(`score${readingState.currentStudent + 1}`).textContent = currentScore;

    // æ›´æ–°å­¦ç”ŸçŠ¶æ€
    updateStudentStatus();

    // æ›´æ–°å­¦ç”Ÿåå­—é¢œè‰²ï¼ˆæ ¹æ®åˆ†æ•°ç­‰çº§ï¼‰
    updateStudentLevelColor();
}

// æ›´æ–°å­¦ç”ŸçŠ¶æ€
function updateStudentStatus() {
    const currentScore = readingState.studentScores[readingState.currentStudent];
    let status = "å‡†å¤‡å¼€å§‹æœ—è¯»";

    if (currentScore >= 600) {
        status = "æœ—è¯»å¤§å¸ˆï¼ğŸ†";
    } else if (currentScore >= 500) {
        status = "æ¥è¿‘æ»¡åˆ†ï¼ğŸ†";
    } else if (currentScore >= 400) {
        status = "éå¸¸ä¼˜ç§€ï¼ğŸ‰";
    } else if (currentScore >= 300) {
        status = "ç»§ç»­åŠ æ²¹ï¼ğŸ‘";
    } else if (currentScore >= 200) {
        status = "è¿›æ­¥å¾ˆå¤§ï¼âœ¨";
    } else if (currentScore >= 100) {
        status = "ç»§ç»­åŠªåŠ›ï¼ğŸ’ª";
    } else if (currentScore > 0) {
        status = "æ­£åœ¨æœ—è¯»ä¸­...";
    }

    document.getElementById(`studentStatus${readingState.currentStudent + 1}`).textContent = status;
}

// æ›´æ–°å­¦ç”Ÿç­‰çº§é¢œè‰²
function updateStudentLevelColor() {
    const currentScore = readingState.studentScores[readingState.currentStudent];
    const studentNameElement = document.getElementById(`studentName${readingState.currentStudent + 1}`);

    // ç§»é™¤æ‰€æœ‰ç­‰çº§ç±»
    studentNameElement.classList.remove('level-0', 'level-100', 'level-200', 'level-300', 'level-400', 'level-500', 'level-600');

    // æ·»åŠ å¯¹åº”ç­‰çº§ç±»
    if (currentScore >= 600) {
        studentNameElement.classList.add('level-600');
    } else if (currentScore >= 500) {
        studentNameElement.classList.add('level-500');
    } else if (currentScore >= 400) {
        studentNameElement.classList.add('level-400');
    } else if (currentScore >= 300) {
        studentNameElement.classList.add('level-300');
    } else if (currentScore >= 200) {
        studentNameElement.classList.add('level-200');
    } else if (currentScore >= 100) {
        studentNameElement.classList.add('level-100');
    } else {
        studentNameElement.classList.add('level-0');
    }
}

// æ›´æ–°æ€»åˆ†
function updateTotalScore() {
    const totalScore = readingState.studentScores.reduce((a, b) => a + b, 0);
    document.getElementById('totalScore').textContent = totalScore;
}

// åœæ­¢æœ—è¯»
function stopReading() {
    if (!readingState.isReading) return;

    readingState.isReading = false;

    // åœæ­¢éŸ³é¢‘å¤„ç†
    if (readingState.audioContext) {
        readingState.audioContext.close();
    }

    // åœæ­¢åŠ¨ç”»
    if (readingState.animationId) {
        cancelAnimationFrame(readingState.animationId);
    }

    // æ›´æ–°UIçŠ¶æ€
    document.getElementById('startReading').disabled = false;
    document.getElementById('stopReading').disabled = true;
    document.getElementById('energyHalo').style.display = 'none';

    // é‡ç½®æ°”æ³¡å¤§å°
    document.getElementById('readingBubble').style.transform = 'scale(1)';
    updateBubbleColor();

    // æ˜¾ç¤ºæœ—è¯»ç»“æœ
    const finalScore = readingState.studentScores[readingState.currentStudent];
    const duration = Math.floor(readingState.readingDuration / 1000);

    let resultMessage = `${students[readingState.currentStudent].name}æœ—è¯»ç»“æŸï¼å¾—åˆ†: ${finalScore}ï¼Œæ—¶é•¿: ${duration}ç§’`;

    if (finalScore >= 300) {
        resultMessage += `ï¼Œè¾¾æˆ${Math.floor(finalScore/100)*100}åˆ†é‡Œç¨‹ç¢‘ï¼`;
    }

    showEncouragement(resultMessage);

    // æ·»åŠ æœ—è¯»è®°å½•
    addCelebrationRecord(`${students[readingState.currentStudent].name}ç»“æŸæœ—è¯»ï¼Œå¾—åˆ†: ${finalScore}`);
}

// åˆ†æ•°å½’é›¶
function resetAllScores() {
    if (readingState.isReading) {
        stopReading();
    }

    if (!confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰åˆ†æ•°å—ï¼Ÿæ‰€æœ‰å­¦ç”Ÿçš„åˆ†æ•°å’Œæˆå°±éƒ½å°†å½’é›¶ï¼")) {
        return;
    }

    // æ’­æ”¾é‡ç½®éŸ³æ•ˆ
    soundSystem.victory();

    // é‡ç½®æ‰€æœ‰åˆ†æ•°å’Œæˆå°±
    readingState.studentScores = [0, 0, 0, 0];
    readingState.milestoneAchievements = { 300: false, 400: false, 500: false, 600: false };
    readingState.lastMilestone = 0;
    readingState.encouragementHistory = [];

    // æ›´æ–°UI
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`score${i}`).textContent = "0";
        document.getElementById(`studentStatus${i}`).textContent = i === 1 ? "å‡†å¤‡å¼€å§‹æœ—è¯»..." : "ç­‰å¾…è½®æ¬¡...";
        document.getElementById(`studentName${i}`).className = "level-0";
    }

    document.getElementById('currentScore').textContent = "0";
    document.getElementById('milestoneFill').style.width = "0%";
    document.getElementById('currentMilestone').textContent = "0/600åˆ†";
    document.getElementById('nextMilestone').innerHTML = `ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘: <span style="font-weight: bold;">300åˆ†</span>`;

    // é‡ç½®æˆå°±æ˜¾ç¤º
    for (const milestone of milestones) {
        const element = document.getElementById(`milestone${milestone.score}`);
        if (element) {
            element.style.opacity = "0.3";
            element.style.transform = "scale(1)";
        }
    }

    // æ›´æ–°æ€»åˆ†
    updateTotalScore();

    // æ¸…ç©ºåº†ç¥è®°å½•
    document.getElementById('celebrationHistory').innerHTML = `
        <div style="text-align: center; color: #9ca3af; padding: 20px;">
            <i class="fas fa-gift"></i> é‡Œç¨‹ç¢‘åº†ç¥è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º
        </div>
    `;

    // é‡ç½®æ°”æ³¡
    updateBubbleColor();
    document.getElementById('bubbleEmoji').textContent = "ğŸ¤";
    document.getElementById('bubbleMotivation').textContent = "å‡†å¤‡å¼€å§‹æœ—è¯»";

    showEncouragement("æ‰€æœ‰åˆ†æ•°å·²é‡ç½®ï¼å¼€å§‹æ–°çš„æŒ‘æˆ˜å§ï¼");

    // æ·»åŠ é‡ç½®è®°å½•
    addCelebrationRecord("ç³»ç»Ÿé‡ç½®ï¼šæ‰€æœ‰åˆ†æ•°å½’é›¶ï¼Œå¼€å§‹æ–°æŒ‘æˆ˜ï¼");

    // åˆ›å»ºé‡ç½®ç‰¹æ•ˆ
    createResetCelebration();
}

// æ˜¾ç¤ºé¼“åŠ±ä¿¡æ¯
function showEncouragement(message) {
    const feed = document.getElementById('encouragementFeed');
    const messageElement = document.getElementById('encouragementMessage');

    messageElement.innerHTML = `<i class="fas fa-comment-alt"></i> ${message}`;

    // éšæœºèƒŒæ™¯é¢œè‰²
    const colors = [
        'linear-gradient(135deg, #f0f9ff, #e0f2fe)',
        'linear-gradient(135deg, #fef3c7, #fde68a)',
        'linear-gradient(135deg, #dcfce7, #bbf7d0)',
        'linear-gradient(135deg, #fce7f3, #fbcfe8)',
        'linear-gradient(135deg, #ede9fe, #ddd6fe)'
    ];
    feed.style.background = colors[Math.floor(Math.random() * colors.length)];

    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    feed.classList.add('emoji-celebration');
    setTimeout(() => {
        feed.classList.remove('emoji-celebration');
    }, 800);
}

// æ·»åŠ åº†ç¥è®°å½•
function addCelebrationRecord(message) {
    const now = new Date();
    const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

    const historyDiv = document.getElementById('celebrationHistory');
    const entry = document.createElement('div');
    entry.style.cssText = `
        padding: 10px 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 10px;
        border-left: 5px solid ${students[readingState.currentStudent].color};
        font-size: 0.9rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    `;
    entry.innerHTML = `<span style="color: #6b7280; font-weight: bold;">[${timeStr}]</span> ${message}`;

    historyDiv.insertBefore(entry, historyDiv.firstChild);

    // é™åˆ¶è®°å½•æ•°é‡
    if (historyDiv.children.length > 10) {
        historyDiv.removeChild(historyDiv.lastChild);
    }
}

// æ›´æ–°æ°”æ³¡é¢œè‰²
function updateBubbleColor() {
    const student = students[readingState.currentStudent];
    const bubble = document.getElementById('readingBubble');

    bubble.style.background = `radial-gradient(circle at 30% 30%, ${student.color}, ${adjustColorBrightness(student.color, -20)})`;
}

// åˆ›å»ºçƒŸèŠ±ç‰¹æ•ˆ
function createFireworksEffect() {
    for (let i = 0; i < 80; i++) {
        setTimeout(() => {
            const firework = document.createElement('div');
            firework.className = 'confetti-burst';
            firework.style.backgroundColor = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'][Math.floor(Math.random() * 6)];
            firework.style.left = Math.random() * 100 + '%';
            firework.style.top = Math.random() * 100 + '%';

            document.body.appendChild(firework);

            let size = Math.random() * 20 + 8;
            let x = Math.random() * 40 - 20;
            let y = Math.random() * 40 - 20;
            let opacity = 1;

            const animate = () => {
                size *= 0.92;
                x *= 0.95;
                y *= 0.95;
                opacity -= 0.02;

                firework.style.width = size + 'px';
                firework.style.height = size + 'px';
                firework.style.transform = `translate(${x}px, ${y}px)`;
                firework.style.opacity = opacity;

                if (opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    firework.remove();
                }
            };

            animate();
        }, i * 40);
    }
}

// åˆ›å»ºèƒœåˆ©ç‰¹æ•ˆ
function createVictoryEffect() {
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const celebration = document.createElement('div');
            celebration.className = 'milestone-celebration';
            celebration.innerHTML = ['ğŸ†', 'ğŸ–ï¸', 'ğŸ¥‡', 'ğŸ‘‘', 'ğŸ’', 'â­'][Math.floor(Math.random() * 6)];
            celebration.style.left = Math.random() * 80 + 10 + '%';
            celebration.style.top = '100%';
            celebration.style.color = ['#f59e0b', '#ef4444', '#8b5cf6'][Math.floor(Math.random() * 3)];

            document.body.appendChild(celebration);
        }, i * 100);
    }
}

// åˆ›å»ºé‡Œç¨‹ç¢‘åº†ç¥
function createMilestoneCelebration(score) {
    const emojis = {
        300: ["ğŸ‘", "ğŸ™Œ", "ğŸ¤", "ğŸ‘"],
        400: ["ğŸ‰", "ğŸŠ", "ğŸ¥³", "ğŸˆ"],
        500: ["ğŸ†", "âœ¨", "ğŸŒŸ", "ğŸ’«"],
        600: ["ğŸ†", "ğŸ–ï¸", "ğŸ¥‡", "ğŸ‘‘"]
    };

    const emojiSet = emojis[score] || ["ğŸ¯"];

    for (let i = 0; i < 20; i++) {
        setTimeout(() => {
            const reward = document.createElement('div');
            reward.className = 'floating-reward';
            reward.innerHTML = emojiSet[Math.floor(Math.random() * emojiSet.length)];
            reward.style.left = Math.random() * 80 + 10 + '%';
            reward.style.top = '80%';
            reward.style.color = students[readingState.currentStudent].color;

            document.querySelector('.smart-bubble-area').appendChild(reward);
        }, i * 150);
    }
}

// åˆ›å»ºé£˜åŠ¨å¥–åŠ±
function createFloatingReward(score) {
    const rewardEmojis = ["ğŸ’¯", "ğŸ¯", "âœ¨", "ğŸŒŸ", "â­", "ğŸ’«", "ğŸ”¥", "ğŸ’ª"];

    for (let i = 0; i < 3; i++) {
        setTimeout(() => {
            const reward = document.createElement('div');
            reward.className = 'floating-reward';
            reward.innerHTML = rewardEmojis[Math.floor(Math.random() * rewardEmojis.length)];
            reward.style.left = Math.random() * 80 + 10 + '%';
            reward.style.top = '80%';
            reward.style.color = score >= 500 ? '#8b5cf6' : 
                                score >= 400 ? '#ef4444' : 
                                score >= 300 ? '#f59e0b' : '#3b82f6';

            document.querySelector('.smart-bubble-area').appendChild(reward);
        }, i * 300);
    }
}

// åˆ›å»ºé‡ç½®åº†ç¥
function createResetCelebration() {
    for (let i = 0; i < 15; i++) {
        setTimeout(() => {
            const particle = document.createElement('div');
            particle.style.cssText = `
                position: absolute;
                width: 12px;
                height: 12px;
                background: linear-gradient(135deg, #8b5cf6, #a78bfa);
                border-radius: 50%;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                z-index: 5;
            `;

            document.querySelector('.smart-bubble-area').appendChild(particle);

            let angle = Math.random() * Math.PI * 2;
            let distance = Math.random() * 150 + 80;
            let duration = Math.random() * 800 + 400;
            let opacity = 1;

            const startTime = Date.now();
            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / duration;

                if (progress < 1) {
                    const currentDistance = distance * progress;
                    const x = Math.cos(angle) * currentDistance;
                    const y = Math.sin(angle) * currentDistance;
                    opacity = 1 - progress;

                    particle.style.transform = `translate(${x}px, ${y}px)`;
                    particle.style.opacity = opacity;

                    requestAnimationFrame(animate);
                } else {
                    particle.remove();
                }
            };

            animate();
        }, i * 50);
    }
}

// åˆå§‹åŒ–é‡Œç¨‹ç¢‘æ ‡è®°
function initMilestoneMarkers() {
    const markersContainer = document.getElementById('milestoneMarkers');
    markersContainer.innerHTML = '';

    for (let i = 1; i <= 6; i++) {
        const score = i * 100;
        const marker = document.createElement('div');
        marker.className = 'milestone-marker';
        marker.style.left = (score / 600 * 100) + '%';

        const label = document.createElement('div');
        label.className = 'milestone-label';
        label.textContent = score + 'åˆ†';
        label.style.left = (score / 600 * 100) + '%';

        markersContainer.appendChild(marker);
        markersContainer.appendChild(label);
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    selectStudent(0);
    initMilestoneMarkers();

    // æ°”æ³¡ç‚¹å‡»äº‹ä»¶
    document.getElementById('readingBubble').addEventListener('click', () => {
        if (readingState.isReading) {
            // ç‚¹å‡»æ°”æ³¡è·å¾—å¥–åŠ±
            const bonus = 30;
            readingState.studentScores[readingState.currentStudent] += bonus;
            updateScoreDisplay();
            soundSystem.bubblePop();

            const currentScore = readingState.studentScores[readingState.currentStudent];
            showEncouragement(`æ°”æ³¡èƒ½é‡ï¼+${bonus}åˆ†å¥–åŠ±ï¼å½“å‰æ€»åˆ†: ${currentScore}`);
            addCelebrationRecord(`${students[readingState.currentStudent].name}ç‚¹å‡»æ°”æ³¡è·å¾—${bonus}åˆ†å¥–åŠ±`);
        }
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            e.preventDefault();
            if (readingState.isReading) {
                stopReading();
            } else {
                startReading();
            }
        }

        if (e.code >= 'Digit1' && e.code <= 'Digit4') {
            const index = parseInt(e.code.slice(-1)) - 1;
            if (index < students.length) {
                selectStudent(index);
            }
        }

        if (e.code === 'KeyR' && e.ctrlKey) {
            resetAllScores();
        }

        if (e.code === 'Escape') {
            if (readingState.isReading) {
                stopReading();
            }
        }
    });

    // åˆå§‹åŒ–æ°”æ³¡é¢œè‰²
    updateBubbleColor();
});
</script>
</body>
</html>